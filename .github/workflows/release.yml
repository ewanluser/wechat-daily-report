name: è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒ

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  packages: write
  actions: read

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'website/**'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      new-version: ${{ steps.version.outputs.new-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: check
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦åŒ…å«ç‰ˆæœ¬æ›´æ–°å…³é”®è¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" =~ (feat|fix|perf|refactor|style|test|docs|build|ci|chore|breaking|BREAKING) ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
          fi

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        if: steps.check.outputs.should-release == 'true'
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          # æ ¹æ®æäº¤ç±»å‹å†³å®šç‰ˆæœ¬æ›´æ–°ç­–ç•¥
          if [[ "$COMMIT_MSG" =~ (BREAKING|breaking) ]]; then
            # ä¸»ç‰ˆæœ¬æ›´æ–°
            NEW_VERSION=$(npm version major --no-git-tag-version --no-commit-hooks)
          elif [[ "$COMMIT_MSG" =~ (feat) ]]; then
            # æ¬¡ç‰ˆæœ¬æ›´æ–°
            NEW_VERSION=$(npm version minor --no-git-tag-version --no-commit-hooks)
          else
            # è¡¥ä¸ç‰ˆæœ¬æ›´æ–°
            NEW_VERSION=$(npm version patch --no-git-tag-version --no-commit-hooks)
          fi
          
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬å·: $NEW_VERSION"

  build-and-release:
    needs: check-changes
    if: needs.check-changes.outputs.should-release == 'true'
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          npm version ${{ needs.check-changes.outputs.new-version }} --no-git-tag-version --no-commit-hooks

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package application
        run: |
          if [ "${{ matrix.platform }}" = "mac" ]; then
            npm run dist:mac
          elif [ "${{ matrix.platform }}" = "win" ]; then
            npm run dist:win
          else
            npm run dist:linux
          fi
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: release/
          retention-days: 1

  create-release:
    needs: [check-changes, build-and-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find ./artifacts -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" | xargs -I {} cp {} release/
          ls -la release/

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release-notes
        run: |
          VERSION="${{ needs.check-changes.outputs.new-version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          cat > release_notes.md << EOF
          ## ğŸ‰ å¾®ä¿¡ç¾¤èŠæ—¥æŠ¥ç”Ÿæˆå™¨ $VERSION
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          $COMMIT_MSG
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ§  **AIæ™ºèƒ½åˆ†æ**ï¼šåŸºäºå…ˆè¿›çš„AIæŠ€æœ¯åˆ†æç¾¤èŠå†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«é‡è¦ä¿¡æ¯
          - ğŸ¯ **è¯é¢˜ç²¾åæå–**ï¼šæ™ºèƒ½è¯†åˆ«è®¨è®ºä¸­çš„é‡è¦è¯é¢˜ï¼Œç”Ÿæˆè¯¦ç»†æ‘˜è¦  
          - ğŸ’¬ **ç¾¤å‹é‡‘å¥æ”¶é›†**ï¼šè‡ªåŠ¨æå–ç¾¤èŠä¸­çš„ç²¾å½©è¨€è®ºå’Œæœ‰ä»·å€¼è§‚ç‚¹
          - ğŸ“‹ **è·Ÿè¿›äº‹é¡¹è¯†åˆ«**ï¼šæ™ºèƒ½è¯†åˆ«éœ€è¦è·Ÿè¿›çš„ä»»åŠ¡ã€å†³ç­–å’Œé‡è¦äº‹é¡¹
          - ğŸ¨ **ç²¾ç¾æ—¥æŠ¥ç”Ÿæˆ**ï¼šç”Ÿæˆç¾è§‚çš„å›¾ç‰‡æ ¼å¼æ—¥æŠ¥ï¼Œæ”¯æŒå¯¼å‡ºåˆ†äº«
          - ğŸ’» **è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒ macOSã€Windowsã€Linux ä¸‰å¤§æ“ä½œç³»ç»Ÿ
          
          ### ğŸ“¦ å®‰è£…åŒ…è¯´æ˜
          - **macOS**: æ”¯æŒ Intel å’Œ Apple Silicon èŠ¯ç‰‡
          - **Windows**: é€‚ç”¨äº Windows 10 åŠä»¥ä¸Šç‰ˆæœ¬
          - **Linux**: AppImage æ ¼å¼ï¼Œå…å®‰è£…ç›´æ¥è¿è¡Œ
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. å®‰è£…åº”ç”¨å¹¶å¯åŠ¨
          3. é…ç½®AIæœåŠ¡è®¾ç½®
          4. é€‰æ‹©ç¾¤èŠå’Œæ—¥æœŸèŒƒå›´
          5. ä¸€é”®ç”Ÿæˆç²¾ç¾æ—¥æŠ¥
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/mengjian-github/wechat-daily-report#readme)
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/mengjian-github/wechat-daily-report/issues)
          - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/mengjian-github/wechat-daily-report/discussions)
          
          æ„Ÿè°¢æ‰€æœ‰ç”¨æˆ·çš„æ”¯æŒï¼å¦‚æœ‰é—®é¢˜è¯·é€šè¿‡GitHub Issuesåé¦ˆã€‚
          EOF

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-changes.outputs.new-version }}
          name: "å¾®ä¿¡ç¾¤èŠæ—¥æŠ¥ç”Ÿæˆå™¨ ${{ needs.check-changes.outputs.new-version }}"
          body_path: release_notes.md
          files: |
            release/*.dmg
            release/*.exe
            release/*.AppImage
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-website:
    needs: [check-changes, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å®‰è£…GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: æ›´æ–°å®˜ç½‘ä¸‹è½½é“¾æ¥
        run: |
          cd website
          VERSION="${{ needs.check-changes.outputs.new-version }}"
          REPO="mengjian-github/wechat-daily-report"
          
          # ç­‰å¾…releaseå®Œå…¨åˆ›å»º
          sleep 30
          
          # è·å–ä¸‹è½½é“¾æ¥
          MAC_INTEL_URL=$(gh release view $VERSION --repo $REPO --json assets -q '.assets[] | select(.name | test(".*\\.dmg$") and (.name | contains("arm64") | not)) | .browser_download_url')
          MAC_ARM_URL=$(gh release view $VERSION --repo $REPO --json assets -q '.assets[] | select(.name | contains("arm64") and (.name | test(".*\\.dmg$"))) | .browser_download_url')
          WINDOWS_URL=$(gh release view $VERSION --repo $REPO --json assets -q '.assets[] | select(.name | test(".*\\.exe$")) | .browser_download_url')
          LINUX_URL=$(gh release view $VERSION --repo $REPO --json assets -q '.assets[] | select(.name | test(".*\\.AppImage$")) | .browser_download_url')
          
          echo "è·å–åˆ°çš„ä¸‹è½½é“¾æ¥ï¼š"
          echo "macOS Intel: $MAC_INTEL_URL"
          echo "macOS ARM: $MAC_ARM_URL"
          echo "Windows: $WINDOWS_URL"
          echo "Linux: $LINUX_URL"
          
          # æ›´æ–°HTMLæ–‡ä»¶ä¸­çš„ä¸‹è½½é“¾æ¥
          if [ -n "$MAC_INTEL_URL" ]; then
            sed -i "s|https://github.com/mengjian-github/wechat-daily-report/releases/latest/download/[^\"]*\\.dmg|$MAC_INTEL_URL|g" index.html
          fi
          if [ -n "$MAC_ARM_URL" ]; then
            sed -i "s|https://github.com/mengjian-github/wechat-daily-report/releases/latest/download/[^\"]*arm64[^\"]*\\.dmg|$MAC_ARM_URL|g" index.html
          fi
          if [ -n "$WINDOWS_URL" ]; then
            sed -i "s|https://github.com/mengjian-github/wechat-daily-report/releases/latest/download/[^\"]*\\.exe|$WINDOWS_URL|g" index.html
          fi
          if [ -n "$LINUX_URL" ]; then
            sed -i "s|https://github.com/mengjian-github/wechat-daily-report/releases/latest/download/[^\"]*\\.AppImage|$LINUX_URL|g" index.html
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æäº¤å®˜ç½‘æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add website/index.html
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°å®˜ç½‘ä¸‹è½½é“¾æ¥åˆ° ${{ needs.check-changes.outputs.new-version }}"
            git push
          fi