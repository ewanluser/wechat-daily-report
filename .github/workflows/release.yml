name: è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒ

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  packages: write
  actions: read

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'website/**'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      new-version: ${{ steps.version.outputs.new-version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        id: check
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦åŒ…å«ç‰ˆæœ¬æ›´æ–°å…³é”®è¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" =~ (feat|fix|perf|refactor|style|test|docs|build|ci|chore|breaking|BREAKING) ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
          fi

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        if: steps.check.outputs.should-release == 'true'
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"
          
          # æ ¹æ®æäº¤ç±»å‹å†³å®šç‰ˆæœ¬æ›´æ–°ç­–ç•¥
          if [[ "$COMMIT_MSG" =~ (BREAKING|breaking) ]]; then
            # ä¸»ç‰ˆæœ¬æ›´æ–°
            echo "æ£€æµ‹åˆ°ç ´åæ€§æ›´æ”¹ï¼Œæ‰§è¡Œä¸»ç‰ˆæœ¬æ›´æ–°"
            NEW_VERSION=$(npm version major --no-git-tag-version --no-commit-hooks)
          elif [[ "$COMMIT_MSG" =~ (feat) ]]; then
            # æ¬¡ç‰ˆæœ¬æ›´æ–°
            echo "æ£€æµ‹åˆ°æ–°åŠŸèƒ½ï¼Œæ‰§è¡Œæ¬¡ç‰ˆæœ¬æ›´æ–°"
            NEW_VERSION=$(npm version minor --no-git-tag-version --no-commit-hooks)
          else
            # è¡¥ä¸ç‰ˆæœ¬æ›´æ–°
            echo "æ‰§è¡Œè¡¥ä¸ç‰ˆæœ¬æ›´æ–°"
            NEW_VERSION=$(npm version patch --no-git-tag-version --no-commit-hooks)
          fi
          
          # æ¸…ç†ç‰ˆæœ¬å·æ ¼å¼ï¼ˆç§»é™¤å¯èƒ½çš„ 'v' å‰ç¼€ï¼‰
          NEW_VERSION=$(echo "$NEW_VERSION" | sed 's/^v//')
          
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬å·: $NEW_VERSION"

  build-and-release:
    needs: check-changes
    if: needs.check-changes.outputs.should-release == 'true'
    strategy:
      matrix:
        include:
          - os: macos-latest
            platform: mac
          - os: windows-latest
            platform: win
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          npm version ${{ needs.check-changes.outputs.new-version }} --no-git-tag-version --no-commit-hooks

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Package application
        run: |
          if [ "${{ matrix.platform }}" = "mac" ]; then
            npm run dist:mac
          elif [ "${{ matrix.platform }}" = "win" ]; then
            npm run dist:win
          else
            npm run dist:linux
          fi
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: release/
          retention-days: 1

  create-release:
    needs: [check-changes, build-and-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          find ./artifacts -name "*.dmg" -o -name "*.exe" -o -name "*.AppImage" | xargs -I {} cp {} release/
          ls -la release/

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        id: release-notes
        run: |
          VERSION="${{ needs.check-changes.outputs.new-version }}"
          COMMIT_MSG=$(git log -1 --pretty=%B)
          
          cat > release_notes.md << EOF
          ## ğŸ‰ å¾®ä¿¡ç¾¤èŠæ—¥æŠ¥ç”Ÿæˆå™¨ $VERSION
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          $COMMIT_MSG
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ§  **AIæ™ºèƒ½åˆ†æ**ï¼šåŸºäºå…ˆè¿›çš„AIæŠ€æœ¯åˆ†æç¾¤èŠå†…å®¹ï¼Œè‡ªåŠ¨è¯†åˆ«é‡è¦ä¿¡æ¯
          - ğŸ¯ **è¯é¢˜ç²¾åæå–**ï¼šæ™ºèƒ½è¯†åˆ«è®¨è®ºä¸­çš„é‡è¦è¯é¢˜ï¼Œç”Ÿæˆè¯¦ç»†æ‘˜è¦  
          - ğŸ’¬ **ç¾¤å‹é‡‘å¥æ”¶é›†**ï¼šè‡ªåŠ¨æå–ç¾¤èŠä¸­çš„ç²¾å½©è¨€è®ºå’Œæœ‰ä»·å€¼è§‚ç‚¹
          - ğŸ“‹ **è·Ÿè¿›äº‹é¡¹è¯†åˆ«**ï¼šæ™ºèƒ½è¯†åˆ«éœ€è¦è·Ÿè¿›çš„ä»»åŠ¡ã€å†³ç­–å’Œé‡è¦äº‹é¡¹
          - ğŸ¨ **ç²¾ç¾æ—¥æŠ¥ç”Ÿæˆ**ï¼šç”Ÿæˆç¾è§‚çš„å›¾ç‰‡æ ¼å¼æ—¥æŠ¥ï¼Œæ”¯æŒå¯¼å‡ºåˆ†äº«
          - ğŸ’» **è·¨å¹³å°æ”¯æŒ**ï¼šæ”¯æŒ macOSã€Windowsã€Linux ä¸‰å¤§æ“ä½œç³»ç»Ÿ
          
          ### ğŸ“¦ å®‰è£…åŒ…è¯´æ˜
          - **macOS**: æ”¯æŒ Intel å’Œ Apple Silicon èŠ¯ç‰‡
          - **Windows**: é€‚ç”¨äº Windows 10 åŠä»¥ä¸Šç‰ˆæœ¬
          - **Linux**: AppImage æ ¼å¼ï¼Œå…å®‰è£…ç›´æ¥è¿è¡Œ
          
          ### ğŸš€ å¿«é€Ÿå¼€å§‹
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
          2. å®‰è£…åº”ç”¨å¹¶å¯åŠ¨
          3. é…ç½®AIæœåŠ¡è®¾ç½®
          4. é€‰æ‹©ç¾¤èŠå’Œæ—¥æœŸèŒƒå›´
          5. ä¸€é”®ç”Ÿæˆç²¾ç¾æ—¥æŠ¥
          
          ### ğŸ”— ç›¸å…³é“¾æ¥
          - ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/mengjian-github/wechat-daily-report#readme)
          - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/mengjian-github/wechat-daily-report/issues)
          - ğŸ’¬ [è®¨è®ºåŒº](https://github.com/mengjian-github/wechat-daily-report/discussions)
          
          æ„Ÿè°¢æ‰€æœ‰ç”¨æˆ·çš„æ”¯æŒï¼å¦‚æœ‰é—®é¢˜è¯·é€šè¿‡GitHub Issuesåé¦ˆã€‚
          EOF

      - name: åˆ›å»ºGitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-changes.outputs.new-version }}
          name: "å¾®ä¿¡ç¾¤èŠæ—¥æŠ¥ç”Ÿæˆå™¨ v${{ needs.check-changes.outputs.new-version }}"
          body_path: release_notes.md
          files: |
            release/*.dmg
            release/*.exe
            release/*.AppImage
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-website:
    needs: [check-changes, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å®‰è£…å¿…è¦å·¥å…·
        run: |
          # å®‰è£…GitHub CLI
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh jq

      - name: è®¤è¯GitHub CLI
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: ç­‰å¾…Releaseå®Œå…¨åˆ›å»º
        run: |
          VERSION="v${{ needs.check-changes.outputs.new-version }}"
          REPO="mengjian-github/wechat-daily-report"
          
          echo "ç­‰å¾…release $VERSION å®Œå…¨åˆ›å»º..."
          
          # æœ€å¤šç­‰å¾…5åˆ†é’Ÿï¼Œç¡®ä¿assetså®Œå…¨ä¸Šä¼ 
          for i in {1..60}; do
            echo "æ£€æŸ¥ç¬¬ $i æ¬¡..."
            
            if gh release view $VERSION --repo $REPO > /dev/null 2>&1; then
              echo "Releaseå­˜åœ¨ï¼Œæ£€æŸ¥assets..."
              
              ASSETS_COUNT=$(gh release view $VERSION --repo $REPO --json assets | jq '.assets | length')
              echo "å½“å‰assetsæ•°é‡: $ASSETS_COUNT"
              
              if [ "$ASSETS_COUNT" -gt 0 ]; then
                echo "Releaseå·²å®Œå…¨åˆ›å»ºï¼Œassetsæ•°é‡: $ASSETS_COUNT"
                break
              fi
            fi
            
            if [ $i -eq 60 ]; then
              echo "ç­‰å¾…è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ..."
              break
            fi
            
            sleep 5
          done

      - name: æ›´æ–°å®˜ç½‘ä¸‹è½½é“¾æ¥
        run: |
          cd website
          VERSION="v${{ needs.check-changes.outputs.new-version }}"
          REPO="mengjian-github/wechat-daily-report"
          
          echo "ä½¿ç”¨ç‰ˆæœ¬å·: $VERSION"
          echo "ä»“åº“: $REPO"
          
          # éªŒè¯releaseæ˜¯å¦å­˜åœ¨
          echo "æ£€æŸ¥release $VERSION æ˜¯å¦å­˜åœ¨..."
          if ! gh release view $VERSION --repo $REPO > /dev/null 2>&1; then
            echo "é”™è¯¯ï¼šRelease $VERSION ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è·å–releaseä¿¡æ¯å¹¶è°ƒè¯•
          echo "è·å–releaseä¿¡æ¯..."
          RELEASE_INFO=$(gh release view $VERSION --repo $REPO --json assets 2>&1)
          RELEASE_EXIT_CODE=$?
          
          echo "GitHub CLI é€€å‡ºç : $RELEASE_EXIT_CODE"
          echo "Releaseä¿¡æ¯åŸå§‹è¾“å‡º: $RELEASE_INFO"
          
          if [ $RELEASE_EXIT_CODE -ne 0 ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–releaseä¿¡æ¯"
            echo "é”™è¯¯è¯¦æƒ…: $RELEASE_INFO"
            exit 1
          fi
          
          # éªŒè¯è¿”å›çš„æ˜¯æœ‰æ•ˆçš„JSON
          if ! echo "$RELEASE_INFO" | jq . > /dev/null 2>&1; then
            echo "é”™è¯¯ï¼šè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼"
            echo "åŸå§‹è¾“å‡º: $RELEASE_INFO"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰assets
          ASSETS_COUNT=$(echo "$RELEASE_INFO" | jq '.assets | length' 2>/dev/null)
          if [ $? -ne 0 ] || [ -z "$ASSETS_COUNT" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è§£æassetsä¿¡æ¯"
            exit 1
          fi
          
          echo "Assetsæ•°é‡: $ASSETS_COUNT"
          
          if [ "$ASSETS_COUNT" -eq 0 ]; then
            echo "è­¦å‘Šï¼šReleaseä¸­æ²¡æœ‰æ‰¾åˆ°ä»»ä½•assets"
            exit 0
          fi
          
          # åˆ—å‡ºæ‰€æœ‰assetsç”¨äºè°ƒè¯•
          echo "æ‰€æœ‰assets:"
          echo "$RELEASE_INFO" | jq -r '.assets[] | .name'
          
          # è·å–ä¸‹è½½é“¾æ¥ï¼Œä¿®å¤APIå­—æ®µé—®é¢˜ï¼ˆä½¿ç”¨urlè€Œä¸æ˜¯browser_download_urlï¼‰
          echo "è·å–ä¸‹è½½é“¾æ¥..."
          
          MAC_INTEL_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains(".dmg")) | select(.name | contains("arm64") | not) | .url' 2>/dev/null | head -1)
          MAC_ARM_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains(".dmg")) | select(.name | contains("arm64")) | .url' 2>/dev/null | head -1)
          WINDOWS_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains(".exe")) | select(.name | contains("Setup")) | .url' 2>/dev/null | head -1)
          LINUX_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | contains(".AppImage")) | .url' 2>/dev/null | head -1)
          
          echo "è·å–åˆ°çš„ä¸‹è½½é“¾æ¥ï¼š"
          echo "macOS Intel: $MAC_INTEL_URL"
          echo "macOS ARM: $MAC_ARM_URL"
          echo "Windows: $WINDOWS_URL"
          echo "Linux: $LINUX_URL"
          
          # æ›´æ–°HTMLæ–‡ä»¶ä¸­çš„ä¸‹è½½é“¾æ¥ï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼
          if [ -n "$MAC_INTEL_URL" ] && [ "$MAC_INTEL_URL" != "null" ]; then
            echo "æ›´æ–°macOS Intelä¸‹è½½é“¾æ¥..."
            sed -i 's|https://github\.com/mengjian-github/wechat-daily-report/releases/[^"]*x64\.dmg|'$MAC_INTEL_URL'|g' index.html
          fi
          if [ -n "$MAC_ARM_URL" ] && [ "$MAC_ARM_URL" != "null" ]; then
            echo "æ›´æ–°macOS ARMä¸‹è½½é“¾æ¥..."
            sed -i 's|https://github\.com/mengjian-github/wechat-daily-report/releases/[^"]*arm64\.dmg|'$MAC_ARM_URL'|g' index.html
          fi
          if [ -n "$WINDOWS_URL" ] && [ "$WINDOWS_URL" != "null" ]; then
            echo "æ›´æ–°Windowsä¸‹è½½é“¾æ¥..."
            sed -i 's|https://github\.com/mengjian-github/wechat-daily-report/releases/[^"]*\.exe|'$WINDOWS_URL'|g' index.html
          fi
          if [ -n "$LINUX_URL" ] && [ "$LINUX_URL" != "null" ]; then
            echo "æ›´æ–°Linuxä¸‹è½½é“¾æ¥..."
            sed -i 's|https://github\.com/mengjian-github/wechat-daily-report/releases/[^"]*\.AppImage|'$LINUX_URL'|g' index.html
          fi

      - name: æäº¤å®˜ç½‘æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add website/index.html
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°å®˜ç½‘ä¸‹è½½é“¾æ¥åˆ° ${{ needs.check-changes.outputs.new-version }}"
            # æ¨é€æ›´æ”¹ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶
            for i in {1..3}; do
              if git push; then
                echo "æˆåŠŸæ¨é€æ›´æ”¹"
                break
              else
                echo "æ¨é€å¤±è´¥ï¼Œé‡è¯• $i/3..."
                sleep 5
              fi
              
              if [ $i -eq 3 ]; then
                echo "æ¨é€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
                exit 1
              fi
            done
          fi